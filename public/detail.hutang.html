<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Detail Hutang • AxStore</title>
  <style>
    :root{
      --bg0:#07090d;
      --bg1:#0b0f17;
      --card:#0e1420cc;
      --stroke:#1f2b3d;
      --text:#e9f0ff;
      --muted:#9bb0d1;
      --accent:#4ade80;
      --accent2:#22c55e;
      --red:#fb7185;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(1200px 800px at 20% 10%, #0f1b33 0%, transparent 60%),
        radial-gradient(900px 700px at 80% 30%, #12284b 0%, transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      color:var(--text);
      overflow:hidden;
    }
    .wrap{
      height: 100svh;
      width: 100vw;
      padding: 18px 16px calc(18px + env(safe-area-inset-bottom));
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .card{
      width: min(520px, 100%);
      background: var(--card);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(14px);
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .btn{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(6,10,16,.55);
      color: var(--text);
      cursor:pointer;
    }
    h1{ margin:0; font-size: 18px; }
    .meta{ margin:6px 0 0 0; color:var(--muted); font-size:12px; }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(6,10,16,.55);
      margin-top: 12px;
    }
    .sum{
      font-size: 22px;
      font-weight: 800;
      letter-spacing:.2px;
    }
    .sum.green{ color: var(--accent); }
    .sum.red{ color: var(--red); }
    .list{
      margin-top: 14px;
      border-top: 1px solid rgba(255,255,255,.06);
      padding-top: 12px;
      max-height: 46svh;
      overflow:auto;
    }
    .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .left{ min-width: 0; }
    .t1{ font-weight:700; font-size: 13px; }
    .t2{ color: var(--muted); font-size: 12px; margin-top:4px; }
    .amt{ font-weight:800; white-space:nowrap; }
    .amt.plus{ color: var(--accent); }
    .amt.minus{ color: var(--red); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <button class="btn" onclick="history.back()">← Kembali</button>
        <div style="text-align:right">
          <h1 id="nama">Detail Hutang</h1>
          <div class="meta" id="nomor">-</div>
        </div>
      </div>

      <div class="pill">
        <div style="flex:1">
          <div class="meta">Saldo hutang (tambah - terima)</div>
          <div id="saldo" class="sum">Rp. 0</div>
        </div>
        <div style="text-align:right">
          <div class="meta">Update</div>
          <div class="t1" id="upd">-</div>
        </div>
      </div>

      <div class="list" id="list"></div>
    </div>
  </div>

  <script>
    const qp = new URLSearchParams(location.search);
    const wa = (qp.get("wa") || "").replace(/[^\d]/g,"");

    const $nama = document.getElementById("nama");
    const $nomor = document.getElementById("nomor");
    const $saldo = document.getElementById("saldo");
    const $upd = document.getElementById("upd");
    const $list = document.getElementById("list");

    const n0 = (v) => {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    };
    const rp = (n) => "Rp. " + n0(n).toLocaleString("id-ID");
    const fmtDate = (ms) => {
      const d = new Date(ms);
      if (isNaN(d.getTime())) return "-";
      return d.toLocaleString("id-ID");
    };

    function saldoFromTx(tx){
      return (tx || []).reduce((s,t)=>{
        const amt = n0(t?.amount);
        return s + (t?.type === "tambah" ? amt : -amt);
      },0);
    }

    function rowTx(t){
      const type = (t?.type || "").toLowerCase();
      const amt = n0(t?.amount);
      const isPlus = type === "tambah";
      const signClass = isPlus ? "plus" : "minus";
      const label = isPlus ? "Tambah" : "Terima";
      const note = (t?.note || "").toString();
      const dt = fmtDate(t?.date || t?.waktu || 0);

      const div = document.createElement("div");
      div.className = "row";
      div.innerHTML = `
        <div class="left">
          <div class="t1">${label}${note ? " • " + note : ""}</div>
          <div class="t2">${dt}</div>
        </div>
        <div class="amt ${signClass}">${isPlus ? "+" : "-"} ${rp(amt)}</div>
      `;
      return div;
    }

    async function load(){
      if (!wa || !wa.startsWith("08") || wa.length < 9){
        alert("Nomor tidak valid!");
        location.href = "/";
        return;
      }

      const r = await fetch(`/kv/public?wa=${encodeURIComponent(wa)}`);
      const j = await r.json().catch(()=>({}));

      if (!r.ok){
        alert("Gagal memuat data: " + (j?.error || ("HTTP " + r.status)));
        location.href = "/";
        return;
      }

      if (!j.found){
        alert("Nomor anda belum memiliki catatan hutang!");
        location.href = "/";
        return;
      }

      const v = j.value || {};
      $nama.textContent = v.nama ? ("Hutang • " + v.nama) : "Detail Hutang";
      $nomor.textContent = v.nomor ? v.nomor : wa;
      $upd.textContent = v.updatedAt ? fmtDate(v.updatedAt) : "-";

      const tx = Array.isArray(v.transactions) ? v.transactions : [];
      const saldo = saldoFromTx(tx);
      $saldo.textContent = rp(Math.abs(saldo));
      $saldo.className = "sum " + (saldo >= 0 ? "green" : "red");

      $list.innerHTML = "";
      if (!tx.length){
        $list.innerHTML = `<div class="meta">Belum ada transaksi.</div>`;
        return;
      }

      // terbaru di atas
      tx.slice().sort((a,b)=>n0(b?.date)-n0(a?.date)).forEach(t => $list.appendChild(rowTx(t)));
    }

    load().catch(e=>{
      alert("Error: " + (e?.message || e));
      location.href = "/";
    });
  </script>
</body>
</html>
